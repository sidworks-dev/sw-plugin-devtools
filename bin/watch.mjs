#!/usr/bin/env bun
/**
 * SidworksDevTools — Fast SCSS Watcher
 *
 * Compiles Shopware 6.7 storefront SCSS with dart-sass (~500ms) and
 * runs an SSE server for instant CSS hot-reload without page refresh.
 *
 * Usage: bin/watch.sh (from plugin directory)
 */
import { readFileSync, writeFileSync, mkdirSync, existsSync, watch, statSync, readdirSync } from 'node:fs';
import { resolve, dirname, join } from 'node:path';
import * as sass from 'sass';

const PLUGIN_ROOT = resolve(dirname(new URL(import.meta.url).pathname), '..');

// Find Shopware project root by walking up until we find vendor/shopware
function findProjectRoot() {
    let dir = PLUGIN_ROOT;
    while (dir !== '/') {
        if (existsSync(join(dir, 'vendor/shopware')) && existsSync(join(dir, 'var'))) {
            return dir;
        }
        dir = dirname(dir);
    }
    return null;
}

const PROJECT_ROOT = findProjectRoot();
if (!PROJECT_ROOT) {
    console.error('  \x1b[31m✗\x1b[0m Could not find Shopware project root.');
    process.exit(1);
}

const STOREFRONT_APP = join(PROJECT_ROOT, 'vendor/shopware/storefront/Resources/app/storefront');
const HOT_RELOAD_PORT = 9779;

// ── Load configuration ──────────────────────────────────────────────────────

const themeFiles = JSON.parse(readFileSync(join(PROJECT_ROOT, 'var/theme-files.json'), 'utf-8'));
const plugins = JSON.parse(readFileSync(join(PROJECT_ROOT, 'var/plugins.json'), 'utf-8'));
const features = JSON.parse(readFileSync(join(PROJECT_ROOT, 'var/config_js_features.json'), 'utf-8'));

const themeId = themeFiles.themeId;

// ── Find the actual compiled theme path ─────────────────────────────────────

function findCompiledThemePath() {
    const themeDir = join(PROJECT_ROOT, 'public/theme');
    if (!existsSync(themeDir)) return null;

    let newest = null;
    let newestTime = 0;

    for (const dir of readdirSync(themeDir)) {
        const cssFile = join(themeDir, dir, 'css', 'all.css');
        if (existsSync(cssFile)) {
            const mtime = statSync(cssFile).mtimeMs;
            if (mtime > newestTime) {
                newestTime = mtime;
                newest = cssFile;
            }
        }
    }

    return newest;
}

const outputFile = findCompiledThemePath();
if (!outputFile) {
    console.error('  \x1b[31m✗\x1b[0m No compiled theme CSS found in public/theme/.');
    console.error('    Run: ddev exec bin/console theme:compile --active-only');
    process.exit(1);
}

const outputDir = dirname(outputFile);
const themeHash = outputFile.split('/theme/')[1].split('/')[0];

console.log(`\n  SidworksDevTools — Fast SCSS Watcher`);
console.log(`  ─────────────────────────────────────`);
console.log(`  Project:    ${PROJECT_ROOT}`);
console.log(`  Theme hash: ${themeHash}`);
console.log(`  Output:     public/theme/${themeHash}/css/all.css`);
console.log(`  Hot reload: http://localhost:${HOT_RELOAD_PORT}\n`);

// ── Generate feature flags SCSS map ─────────────────────────────────────────

function generateFeatureFlags() {
    const entries = Object.entries(features)
        .map(([key, val]) => `'${key}': ${val}`)
        .join(',');
    return `$sw-features: (${entries});`;
}

// ── Collect plugin style file paths ─────────────────────────────────────────

function collectPluginStyles() {
    const styles = [];
    for (const [name, plugin] of Object.entries(plugins)) {
        if (plugin.storefront?.styleFiles?.length > 0) {
            for (const styleFile of plugin.storefront.styleFiles) {
                if (styleFile.includes('@Plugins')) continue;
                const fullPath = join(PROJECT_ROOT, styleFile);
                if (existsSync(fullPath)) {
                    styles.push(fullPath);
                } else {
                    console.log(`  \x1b[33m!\x1b[0m Skipping missing: ${styleFile} (${name})`);
                }
            }
        }
    }
    return styles;
}

// ── Map Docker container paths to host paths ────────────────────────────────

function toHostPath(dockerPath) {
    return dockerPath.replace(/^\/var\/www\/html\//, PROJECT_ROOT + '/');
}

// ── Generate SCSS entry content ─────────────────────────────────────────────

function generateEntry() {
    const themeVarsPath = join(PROJECT_ROOT, 'var/theme-variables', `${themeId}.scss`);
    const coreStyles = themeFiles.style.map(s => toHostPath(s.filepath));
    const pluginStyles = collectPluginStyles();

    let entry = '// Auto-generated by SidworksDevTools watch.mjs\n\n';
    entry += generateFeatureFlags() + '\n\n';
    entry += `@import "${themeVarsPath}";\n\n`;
    entry += `$app-css-relative-asset-path: '/theme/${themeHash}/assets';\n`;
    entry += `$sw-asset-public-url: '';\n`;
    entry += `$sw-asset-theme-url: '';\n`;
    entry += `$sw-asset-asset-url: '';\n`;
    entry += `$sw-asset-sitemap-url: '';\n\n`;

    for (const stylePath of coreStyles) {
        entry += `@import "${stylePath}";\n`;
    }
    for (const stylePath of pluginStyles) {
        entry += `@import "${stylePath}";\n`;
    }

    return entry;
}

// ── Custom sass importer to handle ~ prefix (webpack convention) ────────────

const tildeImporter = {
    findFileUrl(url) {
        if (!url.startsWith('~')) return null;
        const cleanUrl = url.substring(1);
        const resolved = join(STOREFRONT_APP, cleanUrl);

        const candidates = [
            resolved + '.scss',
            resolved + '.css',
            dirname(resolved) + '/_' + resolved.split('/').pop() + '.scss',
            resolved + '/_index.scss',
            resolved + '/index.scss',
            resolved,
        ];

        for (const candidate of candidates) {
            if (existsSync(candidate)) {
                return new URL('file://' + candidate);
            }
        }

        return null;
    }
};

// ── Compile SCSS ────────────────────────────────────────────────────────────

let compileTimeout = null;
let isCompiling = false;
let cssVersion = 0;

function compileSCSS() {
    if (isCompiling) return;
    isCompiling = true;

    const entry = generateEntry();
    const startTime = performance.now();

    try {
        const result = sass.compileString(entry, {
            loadPaths: [
                join(STOREFRONT_APP, 'src/scss'),
                STOREFRONT_APP,
            ],
            importers: [tildeImporter],
            style: 'expanded',
            sourceMap: false,
            silenceDeprecations: [
                'import',
                'slash-div',
                'color-functions',
                'global-builtin',
                'if-function',
            ],
        });

        mkdirSync(outputDir, { recursive: true });
        writeFileSync(outputFile, result.css);
        cssVersion++;

        const elapsed = (performance.now() - startTime).toFixed(0);
        console.log(`  \x1b[32m✓\x1b[0m Compiled in ${elapsed}ms`);

        notifyClients('css');
    } catch (error) {
        const elapsed = (performance.now() - startTime).toFixed(0);
        console.error(`  \x1b[31m✗\x1b[0m Failed (${elapsed}ms):`);
        console.error(`    ${error.message.split('\n').join('\n    ')}`);
    } finally {
        isCompiling = false;
    }
}

function debouncedCompile() {
    if (compileTimeout) clearTimeout(compileTimeout);
    compileTimeout = setTimeout(compileSCSS, 50);
}

// ── SSE hot-reload server ───────────────────────────────────────────────────

const clients = new Set();

function notifyClients(type) {
    for (const client of clients) {
        client.write(`data: ${JSON.stringify({ type, version: cssVersion })}\n\n`);
    }
}

// Send keepalive pings every 30s to prevent idle timeouts
setInterval(() => {
    for (const client of clients) {
        client.write(`: ping\n\n`);
    }
}, 30_000);

const CLIENT_SCRIPT = `(function() {
  var es = new EventSource('http://localhost:${HOT_RELOAD_PORT}/events');
  es.onmessage = function(e) {
    var data = JSON.parse(e.data);
    if (data.type === 'css') {
      document.querySelectorAll('link[rel="stylesheet"]').forEach(function(link) {
        if (link.href.indexOf('/theme/') !== -1) {
          var url = new URL(link.href);
          url.searchParams.set('_hot', data.version);
          link.href = url.toString();
        }
      });
    } else if (data.type === 'reload') {
      location.reload();
    }
  };
  es.onerror = function() { console.log('[hot-reload] reconnecting...'); };
  console.log('[hot-reload] connected');
})();`;

const server = Bun.serve({
    port: HOT_RELOAD_PORT,
    idleTimeout: 255, // max value — keeps SSE connections alive
    fetch(req) {
        const url = new URL(req.url);

        if (url.pathname === '/events') {
            return new Response(
                new ReadableStream({
                    start(controller) {
                        const client = {
                            write(data) {
                                controller.enqueue(new TextEncoder().encode(data));
                            },
                        };
                        clients.add(client);
                        req.signal.addEventListener('abort', () => clients.delete(client));
                    },
                }),
                {
                    headers: {
                        'Content-Type': 'text/event-stream',
                        'Cache-Control': 'no-cache',
                        'Connection': 'keep-alive',
                        'Access-Control-Allow-Origin': '*',
                    },
                },
            );
        }

        if (url.pathname === '/client.js') {
            return new Response(CLIENT_SCRIPT, {
                headers: {
                    'Content-Type': 'application/javascript',
                    'Access-Control-Allow-Origin': '*',
                },
            });
        }

        if (url.pathname === '/') {
            return new Response(
                `SidworksDevTools — Hot-reload server\n\n` +
                `Theme hash: ${themeHash}\n` +
                `Output: public/theme/${themeHash}/css/all.css\n`,
                { headers: { 'Content-Type': 'text/plain' } },
            );
        }

        return new Response('Not found', { status: 404 });
    },
});

// ── Initial compilation ─────────────────────────────────────────────────────

console.log('  Building SCSS...');
compileSCSS();

// ── Watch SCSS files ────────────────────────────────────────────────────────

const watchDirs = [
    join(PROJECT_ROOT, 'custom/plugins'),
    join(STOREFRONT_APP, 'src/scss'),
    join(PROJECT_ROOT, 'var/theme-variables'),
];

console.log('\n  Watching:');
for (const dir of watchDirs) {
    if (!existsSync(dir)) continue;
    const shortDir = dir.replace(PROJECT_ROOT + '/', '');
    console.log(`    ${shortDir}`);

    watch(dir, { recursive: true }, (eventType, filename) => {
        if (!filename) return;
        if (!filename.endsWith('.scss') && !filename.endsWith('.css')) return;
        console.log(`  \x1b[33m⟳\x1b[0m ${filename}`);
        debouncedCompile();
    });
}

console.log('\n  Ready. Waiting for changes...\n');
